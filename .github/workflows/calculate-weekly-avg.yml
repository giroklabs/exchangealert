name: Calculate 52-Week Averages

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ)ì— ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  calculate-averages:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Calculate 52-week averages from history
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          console.log('ğŸ“Š ìˆ˜ì¶œì…ì€í–‰ API íˆìŠ¤í† ë¦¬ ë°ì´í„°ì—ì„œ 52ì£¼ í‰ê·  ê³„ì‚°...');

          // í™˜ìœ¨ íˆìŠ¤í† ë¦¬ ë°ì´í„° ë¡œë“œ
          const historyDir = path.join('data', 'history');
          if (!fs.existsSync(historyDir)) {
            console.error('âŒ íˆìŠ¤í† ë¦¬ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', historyDir);
            process.exit(1);
          }

          // íŒŒì¼ëª…ì—ì„œ ë‚ ì§œ ì¶”ì¶œ í•¨ìˆ˜ (YYYY-MM-DD ë˜ëŠ” YYYYMMDD í˜•ì‹ ì§€ì›)
          function extractDate(filename) {
            const match = filename.match(/exchange-rates-(\d{4})-?(\d{2})-?(\d{2})\.json/);
            if (match) {
              return `${match[1]}-${match[2]}-${match[3]}`;
            }
            return null;
          }

          const files = fs.readdirSync(historyDir)
            .filter(f => f.startsWith('exchange-rates-') && f.endsWith('.json'))
            .map(f => ({ filename: f, date: extractDate(f) }))
            .filter(f => f.date !== null)
            .sort((a, b) => b.date.localeCompare(a.date)) // ìµœì‹ ìˆœ
            .slice(0, 52); // ìµœê·¼ 52ì£¼

          console.log(`ğŸ“ ${files.length}ê°œì˜ íˆìŠ¤í† ë¦¬ íŒŒì¼ ë°œê²¬`);

          // í™˜ìœ¨ ë°ì´í„°ë¥¼ ë‚ ì§œë³„ë¡œ ì €ì¥
          const exchangeRateByDate = new Map();
          for (const { filename, date } of files) {
            try {
              const filePath = path.join(historyDir, filename);
              const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
              const usd = data.find(r => r.cur_unit === 'USD');
              if (usd && usd.deal_bas_r) {
                const rate = parseFloat(usd.deal_bas_r.replace(/,/g, ''));
                if (!isNaN(rate) && rate > 0) {
                  exchangeRateByDate.set(date, rate);
                }
              }
            } catch (e) {
              console.error(`âš ï¸ ${filename} ì½ê¸° ì˜¤ë¥˜:`, e.message);
            }
          }

          if (exchangeRateByDate.size === 0) {
            console.error('âŒ í™˜ìœ¨ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            process.exit(1);
          }

          console.log(`âœ… ${exchangeRateByDate.size}ê°œì˜ í™˜ìœ¨ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ`);

          // í™˜ìœ¨ ë°°ì—´ ìƒì„±
          const exchangeRates = Array.from(exchangeRateByDate.values());
          const sorted = [...exchangeRates].sort((a, b) => a - b);
          const exchangeRateAvg = {
            low: sorted[0],
            high: sorted[sorted.length - 1],
            average: exchangeRates.reduce((a, b) => a + b, 0) / exchangeRates.length
          };

          console.log('ğŸ“ˆ í™˜ìœ¨ 52ì£¼ í‰ê· :', exchangeRateAvg);

          // ë‹¬ëŸ¬ ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ (ì´ë¯¸ ì €ì¥ëœ íŒŒì¼ì—ì„œ)
          let dollarIndexData = null;
          let dollarIndexAvg = { low: 0, high: 0, average: 0 };
          const dollarIndexPath = path.join('dollar-investment-web', 'public', 'data', 'dollar-index.json');
          if (fs.existsSync(dollarIndexPath)) {
            try {
              dollarIndexData = JSON.parse(fs.readFileSync(dollarIndexPath, 'utf8'));
              if (dollarIndexData['52week']) {
                dollarIndexAvg = dollarIndexData['52week'];
                console.log('ğŸ“Š ë‹¬ëŸ¬ ì§€ìˆ˜ 52ì£¼ í‰ê· :', dollarIndexAvg);
              }
            } catch (e) {
              console.warn('âš ï¸ ë‹¬ëŸ¬ ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e.message);
            }
          }

          // ë‹¬ëŸ¬ ê°­ ë¹„ìœ¨ ê³„ì‚°: ê° ë‚ ì§œë³„ë¡œ ê°­ ë¹„ìœ¨ì„ ê³„ì‚°í•œ í›„ í‰ê·  êµ¬í•˜ê¸°
          const gapRatios = [];
          if (dollarIndexData && dollarIndexData.history) {
            // ë‹¬ëŸ¬ì§€ìˆ˜ íˆìŠ¤í† ë¦¬ë¥¼ ë‚ ì§œë³„ë¡œ ë§¤í•‘
            const dollarIndexByDate = new Map();
            for (const item of dollarIndexData.history) {
              dollarIndexByDate.set(item.date, item.value);
            }

            // í™˜ìœ¨ê³¼ ë‹¬ëŸ¬ì§€ìˆ˜ë¥¼ ë‚ ì§œë³„ë¡œ ë§¤ì¹­í•˜ì—¬ ê°­ ë¹„ìœ¨ ê³„ì‚°
            for (const [date, exchangeRate] of exchangeRateByDate.entries()) {
              const dollarIndex = dollarIndexByDate.get(date);
              if (dollarIndex && dollarIndex > 0) {
                const gapRatio = (exchangeRate / dollarIndex) * 100;
                gapRatios.push(gapRatio);
              }
            }
          }

          let gapRatioAvg = 0;
          if (gapRatios.length > 0) {
            gapRatioAvg = gapRatios.reduce((a, b) => a + b, 0) / gapRatios.length;
            console.log(`ğŸ“Š ë‹¬ëŸ¬ ê°­ ë¹„ìœ¨ ê³„ì‚°: ${gapRatios.length}ê°œ ë‚ ì§œ ë§¤ì¹­, í‰ê· : ${gapRatioAvg.toFixed(2)}`);
          } else {
            // ë§¤ì¹­ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ê³„ì‚° (fallback)
            if (dollarIndexAvg.average > 0) {
              gapRatioAvg = exchangeRateAvg.average / dollarIndexAvg.average * 100;
              console.warn('âš ï¸ ë‚ ì§œë³„ ë§¤ì¹­ ì‹¤íŒ¨, í‰ê· ê°’ìœ¼ë¡œ ê³„ì‚°:', gapRatioAvg.toFixed(2));
            }
          }

          const weeklyAverages = {
            date: new Date().toISOString().split('T')[0],
            exchangeRate: exchangeRateAvg,
            dollarIndex: dollarIndexAvg,
            gapRatio: {
              average: gapRatioAvg
            }
          };

          // dollar-investment-web/public/dataì— ì €ì¥
          const outputPath = path.join('dollar-investment-web', 'public', 'data', 'weekly-averages.json');
          fs.mkdirSync(path.dirname(outputPath), { recursive: true });
          fs.writeFileSync(outputPath, JSON.stringify(weeklyAverages, null, 2));
          console.log('âœ… 52ì£¼ í‰ê·  ë°ì´í„° ìƒì„± ì™„ë£Œ');
          console.log(JSON.stringify(weeklyAverages, null, 2));
          EOF

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add dollar-investment-web/public/data/weekly-averages.json
          git diff --staged --quiet || git commit -m "Update 52-week averages [skip ci]"
          git push

