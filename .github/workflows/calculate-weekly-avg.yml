name: Calculate 52-Week Averages

on:
  schedule:
    # 매일 한국시간 오전 9시 (UTC 0시)에 실행
    - cron: '0 0 * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  calculate-averages:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Calculate 52-week averages
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          // 환율 히스토리 데이터 로드
          const historyDir = path.join('data', 'history');
          const files = fs.readdirSync(historyDir)
            .filter(f => f.startsWith('exchange-rates-') && f.endsWith('.json'))
            .sort()
            .slice(-52); // 최근 52주

          const exchangeRates = [];
          for (const file of files) {
            try {
              const data = JSON.parse(fs.readFileSync(path.join(historyDir, file), 'utf8'));
              const usd = data.find(r => r.cur_unit === 'USD');
              if (usd) {
                const rate = parseFloat(usd.deal_bas_r.replace(/,/g, ''));
                exchangeRates.push(rate);
              }
            } catch (e) {
              console.error(`Error reading ${file}:`, e.message);
            }
          }

          // 52주 평균 계산
          const sorted = [...exchangeRates].sort((a, b) => a - b);
          const exchangeRateAvg = {
            low: sorted[0] || 0,
            high: sorted[sorted.length - 1] || 0,
            average: exchangeRates.reduce((a, b) => a + b, 0) / exchangeRates.length || 0
          };

          // 달러 지수는 샘플 데이터 유지 (실제 API 연동 필요)
          const dollarIndexAvg = {
            low: 91.73,
            high: 103.96,
            average: 97.84
          };

          // 달러 갭 비율 평균 계산
          const gapRatioAvg = exchangeRateAvg.average / dollarIndexAvg.average * 100;

          const weeklyAverages = {
            date: new Date().toISOString().split('T')[0],
            exchangeRate: exchangeRateAvg,
            dollarIndex: dollarIndexAvg,
            gapRatio: {
              average: gapRatioAvg
            }
          };

          // dollar-investment-web/public/data에 저장
          const outputPath = path.join('dollar-investment-web', 'public', 'data', 'weekly-averages.json');
          fs.mkdirSync(path.dirname(outputPath), { recursive: true });
          fs.writeFileSync(outputPath, JSON.stringify(weeklyAverages, null, 2));
          console.log('52주 평균 데이터 생성 완료:', JSON.stringify(weeklyAverages, null, 2));
          EOF

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add dollar-investment-web/public/data/weekly-averages.json
          git diff --staged --quiet || git commit -m "Update 52-week averages [skip ci]"
          git push

