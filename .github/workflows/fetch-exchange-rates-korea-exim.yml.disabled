name: Fetch Exchange Rates

on:
  schedule:
    # í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ 11ì‹œ ì´í›„ë¶€í„° 1ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ìµœì†Œ ê°„ê²©)
    # KST = UTC + 9ì‹œê°„
    # í•œêµ­ì‹œê°„ 11ì‹œ-23ì‹œ = UTC 2ì‹œ-14ì‹œ
    - cron: '* 2-14 * * *'  # UTC 2ì‹œ-14ì‹œ (í•œêµ­ì‹œê°„ 11ì‹œ-23ì‹œ) 1ë¶„ë§ˆë‹¤
    # í•œêµ­ì‹œê°„ ìƒˆë²½ 0ì‹œ-8ì‹œ = UTC 15ì‹œ-23ì‹œ (ì „ë‚ )
    - cron: '* 15-23 * * *'  # UTC 15ì‹œ-23ì‹œ (í•œêµ­ì‹œê°„ 0ì‹œ-8ì‹œ ë‹¤ìŒë‚ ) 1ë¶„ë§ˆë‹¤
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  fetch-rates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create data directories
      run: |
        mkdir -p data
        mkdir -p data/history
        mkdir -p data/daily
      
    - name: Fetch exchange rates
      run: |
        # í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ìœ¼ë¡œ ìš”ì¼ ë° ì‹œê°„ í™•ì¸
        DAY_OF_WEEK=$(TZ='Asia/Seoul' date +%w)
        KST_HOUR=$(TZ='Asia/Seoul' date +%H)
        KST_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
        
        echo "=== í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ ì •ë³´ ==="
        echo "í˜„ì¬ í•œêµ­ ì‹œê°„: $KST_DATE"
        echo "ìš”ì¼: $DAY_OF_WEEK (ì¼ìš”ì¼=0, ì›”ìš”ì¼=1, ..., í† ìš”ì¼=6)"
        echo "í•œêµ­ ì‹œê°„ëŒ€: $KST_HOURì‹œ"
        
        # ì£¼ë§ì—ë„ searchdate íŒŒë¼ë¯¸í„°ë¡œ ë§ˆì§€ë§‰ í‰ì¼ ë°ì´í„° ìš”ì²­ ê°€ëŠ¥
        # (ì´ì „ì—ëŠ” ì£¼ë§ì— ì•„ì˜ˆ API í˜¸ì¶œì„ í•˜ì§€ ì•Šì•˜ì§€ë§Œ, ì´ì œëŠ” ê¸ˆìš”ì¼ ë°ì´í„°ë¥¼ ìš”ì²­)
        
        # ì˜ì—…ì¼ 11ì‹œ ì´ì „ì¸ ê²½ìš° ë§ˆì§€ë§‰ ë°ì´í„° ìœ ì§€
        if [ $KST_HOUR -lt 11 ]; then
          echo "ì˜ì—…ì¼ 11ì‹œ ì´ì „ì…ë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          exit 0
        fi
        
        # í‰ì¼ 11ì‹œ ì´í›„ì¸ ê²½ìš° í•œêµ­ìˆ˜ì¶œì…ì€í–‰ APIì—ì„œ í™˜ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        echo "í‰ì¼ 11ì‹œ ì´í›„ì…ë‹ˆë‹¤. ìˆ˜ì¶œì…ì€í–‰ APIì—ì„œ ìµœì‹  í™˜ìœ¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."
        
        # searchdate íŒŒë¼ë¯¸í„° ì„¤ì • (ì£¼ë§ì—ëŠ” ë§ˆì§€ë§‰ í‰ì¼ ë°ì´í„° ìš”ì²­)
        SEARCH_DATE=$(TZ='Asia/Seoul' date '+%Y%m%d')
        
        # ì£¼ë§ì¸ ê²½ìš° ë§ˆì§€ë§‰ í‰ì¼(ê¸ˆìš”ì¼) ë‚ ì§œë¡œ ì„¤ì •
        if [ $DAY_OF_WEEK -eq 6 ]; then
          # í† ìš”ì¼ì¸ ê²½ìš° ì „ë‚ (ê¸ˆìš”ì¼) ë‚ ì§œ
          SEARCH_DATE=$(TZ='Asia/Seoul' date -d 'yesterday' '+%Y%m%d')
          echo "í† ìš”ì¼ ê°ì§€: ê¸ˆìš”ì¼ ë°ì´í„° ìš”ì²­ ($SEARCH_DATE)"
        elif [ $DAY_OF_WEEK -eq 0 ]; then
          # ì¼ìš”ì¼ì¸ ê²½ìš° ì´í‹€ ì „(ê¸ˆìš”ì¼) ë‚ ì§œ  
          SEARCH_DATE=$(TZ='Asia/Seoul' date -d '2 days ago' '+%Y%m%d')
          echo "ì¼ìš”ì¼ ê°ì§€: ê¸ˆìš”ì¼ ë°ì´í„° ìš”ì²­ ($SEARCH_DATE)"
        else
          echo "í‰ì¼: ë‹¹ì¼ ë°ì´í„° ìš”ì²­ ($SEARCH_DATE)"
        fi
        
        # API í˜¸ì¶œ (searchdate íŒŒë¼ë¯¸í„° í¬í•¨)
        echo "API í˜¸ì¶œ: searchdate=$SEARCH_DATE"
        curl -o data/exchange-rates.json "https://oapi.koreaexim.go.kr/site/program/financial/exchangeJSON?authkey=${{ secrets.KOREA_EXIM_API_KEY }}&searchdate=$SEARCH_DATE&data=AP01"
        
        # ë‚ ì§œë³„ íŒŒì¼ëª… ìƒì„±
        HISTORY_FILENAME="data/history/exchange-rates-${SEARCH_DATE}.json"
        DAILY_FILENAME="data/daily/exchange-rates-${SEARCH_DATE}.json"
        
        # API ì‘ë‹µ í™•ì¸
        if [ ! -s data/exchange-rates.json ]; then
          echo "âŒ API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          exit 0
        fi
        
        # JSON ë°°ì—´ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        if [ "$(cat data/exchange-rates.json | jq 'length')" -eq 0 ]; then
          echo "âŒ APIì—ì„œ ë¹ˆ ë°°ì—´ì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          exit 0
        fi
        
        # ì²« ë²ˆì§¸ í•­ëª©ì´ nullì¸ì§€ í™•ì¸
        FIRST_ITEM=$(cat data/exchange-rates.json | jq '.[0] // empty')
        if [ -z "$FIRST_ITEM" ] || [ "$FIRST_ITEM" = "null" ]; then
          echo "âŒ APIì—ì„œ null ë°ì´í„°ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          exit 0
        fi
        
        echo "âœ… APIì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤."
        cat data/exchange-rates.json | jq '.[0] | {cur_nm: .cur_nm, deal_bas_r: .deal_bas_r}'
        
        # ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë‚ ì§œë³„ íŒŒì¼ë¡œ ì €ì¥
        echo "ğŸ“ ë‚ ì§œë³„ ë°ì´í„° ì €ì¥: $HISTORY_FILENAME"
        cp data/exchange-rates.json "$HISTORY_FILENAME"
        cp data/exchange-rates.json "$DAILY_FILENAME"
        
        # ë©”íƒ€ë°ì´í„° ì¶”ê°€ (ì €ì¥ ì‹œê°„, API ì†ŒìŠ¤ ë“±)
        echo "ğŸ“Š ë©”íƒ€ë°ì´í„° ì¶”ê°€"
        echo "{\"date\":\"$SEARCH_DATE\",\"fetch_time\":\"$(TZ='Asia/Seoul' date -Iseconds)\",\"api_source\":\"korea_exim_bank\",\"data_count\":$(cat data/exchange-rates.json | jq 'length'),\"search_date\":\"$SEARCH_DATE\"}" > "data/history/meta-${SEARCH_DATE}.json"
        
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ìœ¼ë¡œ ì¡°ê±´ í™•ì¸
        DAY_OF_WEEK=$(TZ='Asia/Seoul' date +%w)
        KST_HOUR=$(TZ='Asia/Seoul' date +%H)
        KST_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
        
        echo "=== ì»¤ë°‹ ë‹¨ê³„ - í•œêµ­ ì‹œê°„ ê¸°ì¤€ ==="
        echo "í˜„ì¬ í•œêµ­ ì‹œê°„: $KST_DATE"
        echo "ìš”ì¼: $DAY_OF_WEEK, ì‹œê°„: $KST_HOURì‹œ"
        
        # 11ì‹œ ì´ì „ì¸ ê²½ìš° ì»¤ë°‹ ê±´ë„ˆë›°ê¸° (ì£¼ë§ì€ ì´ì œ API í˜¸ì¶œí•¨)
        if [ $KST_HOUR -lt 11 ]; then
          echo "í•œêµ­ì‹œê°„ 11ì‹œ ì´ì „ì´ë¯€ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          exit 0
        fi
        
        # ìœ íš¨í•œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
        if [ -f data/exchange-rates.json ] && [ -s data/exchange-rates.json ]; then
          DATA_LENGTH=$(cat data/exchange-rates.json | jq 'length')
          if [ "$DATA_LENGTH" -gt 0 ]; then
            # ëª¨ë“  ë°ì´í„° íŒŒì¼ ì¶”ê°€ (í˜„ì¬ + ëˆ„ì )
            git add data/exchange-rates.json
            git add data/history/*.json 2>/dev/null || true
            git add data/daily/*.json 2>/dev/null || true
            
            if ! git diff --staged --quiet; then
              COMMIT_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
              # SEARCH_DATE ì¬ê³„ì‚° (ì›Œí¬í”Œë¡œìš° ì²« ë²ˆì§¸ ë‹¨ê³„ì™€ ë™ì¼í•œ ë¡œì§)
              SEARCH_DATE=$(TZ='Asia/Seoul' date '+%Y%m%d')
              
              # ì£¼ë§ì¸ ê²½ìš° ë§ˆì§€ë§‰ í‰ì¼ ë‚ ì§œë¡œ ì„¤ì •
              if [ $DAY_OF_WEEK -eq 6 ]; then
                SEARCH_DATE=$(TZ='Asia/Seoul' date -d 'yesterday' '+%Y%m%d')
              elif [ $DAY_OF_WEEK -eq 0 ]; then
                SEARCH_DATE=$(TZ='Asia/Seoul' date -d '2 days ago' '+%Y%m%d')
              fi
              
              git commit -m "Update exchange rates - $COMMIT_DATE - Current: data/exchange-rates.json - Historical: data/history/exchange-rates-$SEARCH_DATE.json - Daily: data/daily/exchange-rates-$SEARCH_DATE.json - Metadata: data/history/meta-$SEARCH_DATE.json - Count: $DATA_LENGTH currencies"
              
              git push
              echo "Exchange rate data updated successfully."
              echo "Stored $DATA_LENGTH currencies"
            else
              echo "No data changes."
            fi
          else
            echo "No valid data to commit."
          fi
        else
          echo "No data file or empty file."
        fi