name: Fetch Exchange Rates

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ê¸°ì¤€ 11ì‹œ ì´í›„ë¶€í„° 2ë¶„ë§ˆë‹¤ ì‹¤í–‰ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
    # UTC ì‹œê°„ìœ¼ë¡œëŠ” 2ì‹œë¶€í„° ì‹œì‘ (í•œêµ­ ì‹œê°„ 11ì‹œ = UTC 2ì‹œ)
    - cron: '*/2 2-23 * * *'  # UTC 2ì‹œ-23ì‹œ (í•œêµ­ ì‹œê°„ 11ì‹œ-ë‹¤ìŒë‚  8ì‹œ) 2ë¶„ë§ˆë‹¤
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  fetch-rates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create data directory
      run: mkdir -p data
      
    - name: Fetch exchange rates
      run: |
        # í˜„ì¬ ìš”ì¼ í™•ì¸ (0=ì¼ìš”ì¼, 1=ì›”ìš”ì¼, ..., 6=í† ìš”ì¼)
        DAY_OF_WEEK=$(date +%w)
        KST_HOUR=$(TZ='Asia/Seoul' date +%H)
        
        echo "í˜„ì¬ ìš”ì¼: $DAY_OF_WEEK (í† ìš”ì¼=6, ì¼ìš”ì¼=0)"
        echo "í•œêµ­ ì‹œê°„: $(TZ='Asia/Seoul' date)"
        echo "í•œêµ­ ì‹œê°„ëŒ€: $KST_HOURì‹œ"
        
        # ì£¼ë§ì—ë„ searchdate íŒŒë¼ë¯¸í„°ë¡œ ë§ˆì§€ë§‰ í‰ì¼ ë°ì´í„° ìš”ì²­ ê°€ëŠ¥
        # (ì´ì „ì—ëŠ” ì£¼ë§ì— ì•„ì˜ˆ API í˜¸ì¶œì„ í•˜ì§€ ì•Šì•˜ì§€ë§Œ, ì´ì œëŠ” ê¸ˆìš”ì¼ ë°ì´í„°ë¥¼ ìš”ì²­)
        
        # ì˜ì—…ì¼ 11ì‹œ ì´ì „ì¸ ê²½ìš° ë§ˆì§€ë§‰ ë°ì´í„° ìœ ì§€
        if [ $KST_HOUR -lt 11 ]; then
          echo "ì˜ì—…ì¼ 11ì‹œ ì´ì „ì…ë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          exit 0
        fi
        
        # í‰ì¼ 11ì‹œ ì´í›„ì¸ ê²½ìš° í•œêµ­ìˆ˜ì¶œì…ì€í–‰ APIì—ì„œ í™˜ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        echo "í‰ì¼ 11ì‹œ ì´í›„ì…ë‹ˆë‹¤. ìˆ˜ì¶œì…ì€í–‰ APIì—ì„œ ìµœì‹  í™˜ìœ¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."
        
        # searchdate íŒŒë¼ë¯¸í„° ì„¤ì • (ì£¼ë§ì—ëŠ” ë§ˆì§€ë§‰ í‰ì¼ ë°ì´í„° ìš”ì²­)
        SEARCH_DATE=$(TZ='Asia/Seoul' date '+%Y%m%d')
        
        # ì£¼ë§ì¸ ê²½ìš° ë§ˆì§€ë§‰ í‰ì¼(ê¸ˆìš”ì¼) ë‚ ì§œë¡œ ì„¤ì •
        if [ $DAY_OF_WEEK -eq 6 ]; then
          # í† ìš”ì¼ì¸ ê²½ìš° ì „ë‚ (ê¸ˆìš”ì¼) ë‚ ì§œ
          SEARCH_DATE=$(TZ='Asia/Seoul' date -d 'yesterday' '+%Y%m%d')
          echo "í† ìš”ì¼ ê°ì§€: ê¸ˆìš”ì¼ ë°ì´í„° ìš”ì²­ ($SEARCH_DATE)"
        elif [ $DAY_OF_WEEK -eq 0 ]; then
          # ì¼ìš”ì¼ì¸ ê²½ìš° ì´í‹€ ì „(ê¸ˆìš”ì¼) ë‚ ì§œ  
          SEARCH_DATE=$(TZ='Asia/Seoul' date -d '2 days ago' '+%Y%m%d')
          echo "ì¼ìš”ì¼ ê°ì§€: ê¸ˆìš”ì¼ ë°ì´í„° ìš”ì²­ ($SEARCH_DATE)"
        else
          echo "í‰ì¼: ë‹¹ì¼ ë°ì´í„° ìš”ì²­ ($SEARCH_DATE)"
        fi
        
        # API í˜¸ì¶œ (searchdate íŒŒë¼ë¯¸í„° í¬í•¨)
        echo "API í˜¸ì¶œ: searchdate=$SEARCH_DATE"
        curl -o data/exchange-rates.json "https://oapi.koreaexim.go.kr/site/program/financial/exchangeJSON?authkey=${{ secrets.KOREA_EXIM_API_KEY }}&searchdate=$SEARCH_DATE&data=AP01"
        
        # API ì‘ë‹µ í™•ì¸
        if [ ! -s data/exchange-rates.json ]; then
          echo "âŒ API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          exit 0
        fi
        
        # JSON ë°°ì—´ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        if [ "$(cat data/exchange-rates.json | jq 'length')" -eq 0 ]; then
          echo "âŒ APIì—ì„œ ë¹ˆ ë°°ì—´ì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          exit 0
        fi
        
        # ì²« ë²ˆì§¸ í•­ëª©ì´ nullì¸ì§€ í™•ì¸
        FIRST_ITEM=$(cat data/exchange-rates.json | jq '.[0] // empty')
        if [ -z "$FIRST_ITEM" ] || [ "$FIRST_ITEM" = "null" ]; then
          echo "âŒ APIì—ì„œ null ë°ì´í„°ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          exit 0
        fi
        
        echo "âœ… APIì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤."
        cat data/exchange-rates.json | jq '.[0] | {cur_nm: .cur_nm, deal_bas_r: .deal_bas_r}'
        
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ê±´ í™•ì¸
        DAY_OF_WEEK=$(date +%w)
        KST_HOUR=$(TZ='Asia/Seoul' date +%H)
        
        # 11ì‹œ ì´ì „ì¸ ê²½ìš° ì»¤ë°‹ ê±´ë„ˆë›°ê¸° (ì£¼ë§ì€ ì´ì œ API í˜¸ì¶œí•¨)
        if [ $KST_HOUR -lt 11 ]; then
          echo "ì˜ì—…ì¼ 11ì‹œ ì´ì „ì´ë¯€ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          exit 0
        fi
        
        # ìœ íš¨í•œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
        if [ -f data/exchange-rates.json ] && [ -s data/exchange-rates.json ]; then
          DATA_LENGTH=$(cat data/exchange-rates.json | jq 'length')
          if [ "$DATA_LENGTH" -gt 0 ]; then
            git add data/exchange-rates.json
            if ! git diff --staged --quiet; then
              git commit -m "Update exchange rates - $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')"
              git push
              echo "âœ… í™˜ìœ¨ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "ğŸ“Š ë°ì´í„° ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
          else
            echo "âŒ ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ì–´ì„œ ì»¤ë°‹ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi
        else
          echo "âŒ ë°ì´í„° íŒŒì¼ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆì–´ì„œ ì»¤ë°‹ì„ ê±´ë„ˆëœë‹ˆë‹¤."
        fi
