name: Fetch ExchangeRate-API Data (DISABLED)

on:
  # schedule:
    # # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰ (UTC ì‹œê°„ ê¸°ì¤€) - ì›” 1,440íšŒë¡œ ì œí•œ ë‚´ ìœ ì§€
    # - cron: '*/30 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥ (í•„ìš”ì‹œì—ë§Œ)
  # push:
  #   branches: [ main ]

jobs:
  fetch-exchange-rate-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Fetch ExchangeRate-API data (30ë¶„ ê°„ê²©)
      run: |
        echo "ğŸŒ Fetching ExchangeRate-API data (30ë¶„ ê°„ê²©)..."
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # ExchangeRate-API í˜¸ì¶œ (ë¬´ë£Œ ë²„ì „)
        RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "https://api.exchangerate-api.com/v4/latest/KRW")
        
        # HTTP ìƒíƒœì½”ë“œ í™•ì¸
        HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
        DATA=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
        
        if [ "$HTTP_STATUS" != "200" ]; then
          echo "âŒ ExchangeRate-API request failed with status: $HTTP_STATUS"
          echo "Response: $DATA"
          exit 1
        fi
        
        # JSON ìœ íš¨ì„± ê²€ì‚¬
        if ! echo "$DATA" | jq empty 2>/dev/null; then
          echo "âŒ Invalid JSON response from ExchangeRate-API"
          echo "Response: $DATA"
          exit 1
        fi
        
        # ë°ì´í„° ì €ì¥
        echo "$DATA" > data/exchangerate-api.json
        echo "$TIMESTAMP" > data/exchangerate-api-last-update.txt
        
        echo "âœ… Successfully fetched and saved ExchangeRate-API data"
        echo "ğŸ“Š Data contains $(echo "$DATA" | jq '.rates | length') currencies"
        
        # ì£¼ìš” í†µí™” í™˜ìœ¨ ì •ë³´ ì¶œë ¥
        echo "ğŸ’± ì£¼ìš” í†µí™” í™˜ìœ¨ (KRW ê¸°ì¤€):"
        echo "USD: $(echo "$DATA" | jq -r '.rates.USD') â†’ $(echo "scale=2; 1/$(echo "$DATA" | jq -r '.rates.USD')" | bc)ì›"
        echo "EUR: $(echo "$DATA" | jq -r '.rates.EUR') â†’ $(echo "scale=2; 1/$(echo "$DATA" | jq -r '.rates.EUR')" | bc)ì›"
        echo "JPY: $(echo "$DATA" | jq -r '.rates.JPY') â†’ $(echo "scale=2; 1/$(echo "$DATA" | jq -r '.rates.JPY')" | bc)ì›"

    - name: Create backup with timestamp
      run: |
        TIMESTAMP=$(date -u +"%Y%m%d_%H%M")
        cp data/exchangerate-api.json "data/backup/exchangerate-api-backup-$TIMESTAMP.json"
        echo "ğŸ“ Backup created: exchangerate-api-backup-$TIMESTAMP.json"

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/exchangerate-api.json data/exchangerate-api-last-update.txt
        git diff --staged --quiet || git commit -m "Update ExchangeRate-API data - $(date -u +"%Y-%m-%d %H:%M UTC")"
        git push
