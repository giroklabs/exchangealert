name: Fetch Dollar Index

on:
  schedule:
    # Îß§Ïùº ÌïúÍµ≠ÏãúÍ∞Ñ Ïò§ÌõÑ 6Ïãú (UTC 9Ïãú)Ïóê Ïã§Ìñâ
    # FRED APIÎäî ÎØ∏Íµ≠ ÎèôÎ∂Ä ÏãúÍ∞Ñ Í∏∞Ï§ÄÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎØÄÎ°ú, 
    # ÌïúÍµ≠ÏãúÍ∞Ñ Ïò§ÌõÑ 6ÏãúÏóêÎäî ÎãπÏùº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏñ¥ ÏûàÏùÑ Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏùå
    - cron: '0 9 * * *'
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  fetch-dollar-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    env:
      TZ: Asia/Seoul
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Dollar Index from Alpha Vantage API
        env:
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
        run: |
          if [ -z "$ALPHA_VANTAGE_API_KEY" ]; then
            echo "‚ö†Ô∏è Alpha Vantage API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            echo "üìù GitHub SecretsÏóê ALPHA_VANTAGE_API_KEYÎ•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî."
            echo "üí° Î¨¥Î£å API ÌÇ§Îäî https://www.alphavantage.co/support/#api-key ÏóêÏÑú Î∞úÍ∏âÎ∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§."
            echo ""
            echo "üîÑ ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Î•º Ïú†ÏßÄÌï©ÎãàÎã§."
            exit 0
          fi

          echo "üìä Alpha Vantage APIÏóêÏÑú Îã¨Îü¨ ÏßÄÏàò Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞..."
          
          # Alpha Vantage API Ìò∏Ï∂ú (FX_DAILYÎ•º ÏÇ¨Ïö©ÌïòÏó¨ USD/EUR Îì± Ï£ºÏöî ÌÜµÌôî ÎåÄÎπÑ Îã¨Îü¨ Í∞ïÎèÑ Í≥ÑÏÇ∞)
          # ÎòêÎäî FRED API ÏÇ¨Ïö© (DTWEXBGS - Trade Weighted U.S. Dollar Index)
          # ÏùºÎã® FRED APIÎ•º ÏÇ¨Ïö©ÌïòÎäî Í≤ÉÏù¥ Îçî Ï†ïÌôïÌï©ÎãàÎã§
          
          # FRED APIÍ∞Ä ÏóÜÏúºÎ©¥ Alpha VantageÏùò FX Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏ≤¥
          # USD/EUR, USD/JPY, USD/GBP Îì±Ïùò Í∞ÄÏ§ë ÌèâÍ∑†ÏúºÎ°ú Îã¨Îü¨ ÏßÄÏàò Ï∂îÏ†ï
          RESPONSE=$(curl -s "https://www.alphavantage.co/query?function=FX_DAILY&from_symbol=USD&to_symbol=EUR&apikey=$ALPHA_VANTAGE_API_KEY")
          
          # Ïò§Î•ò Ï≤¥ÌÅ¨
          if echo "$RESPONSE" | grep -q '"Error Message"'; then
            echo "‚ùå API Ïò§Î•ò:"
            echo "$RESPONSE" | grep -o '"Error Message":"[^"]*"'
            echo "üîÑ ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Î•º Ïú†ÏßÄÌï©ÎãàÎã§."
            exit 0
          fi
          
          # Alpha VantageÎäî FX Îç∞Ïù¥ÌÑ∞Îßå Ï†úÍ≥µÌïòÎØÄÎ°ú FRED APIÎ•º Ïö∞ÏÑ† ÏÇ¨Ïö©
          # FRED APIÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ
          echo "üí° Alpha VantageÎäî Îã¨Îü¨ ÏßÄÏàòÎ•º ÏßÅÏ†ë Ï†úÍ≥µÌïòÏßÄ ÏïäÏäµÎãàÎã§."
          echo "üí° FRED APIÎ•º ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Î•º Ïú†ÏßÄÌï©ÎãàÎã§."

      - name: Fetch Dollar Index from FRED API
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          if [ -z "$FRED_API_KEY" ]; then
            echo "‚ö†Ô∏è FRED API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            echo "üí° FRED APIÎäî Î¨¥Î£åÏù¥Î©∞ https://fred.stlouisfed.org/docs/api/api_key.html ÏóêÏÑú Î∞úÍ∏âÎ∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§."
            echo "üîÑ ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Î•º Ïú†ÏßÄÌï©ÎãàÎã§."
            exit 0
          fi
          
          echo "üìä FRED APIÏóêÏÑú Îã¨Îü¨ ÏßÄÏàò(DTWEXBGS) Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞..."
          
          # FRED API Ìò∏Ï∂ú - Trade Weighted U.S. Dollar Index: Broad, Goods (DTWEXBGS)
          # ÏµúÍ∑º 1ÎÖÑÏπò Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏïΩ 260 ÏòÅÏóÖÏùº)
          # observation_startÎ•º 1ÎÖÑ Ï†ÑÏúºÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Ï∂©Î∂ÑÌïú Îç∞Ïù¥ÌÑ∞ ÌôïÎ≥¥
          ONE_YEAR_AGO=$(date -d '1 year ago' +%Y-%m-%d 2>/dev/null || date -v-1y +%Y-%m-%d 2>/dev/null || echo "")
          if [ -z "$ONE_YEAR_AGO" ]; then
            # ÎÇ†Ïßú Í≥ÑÏÇ∞ Ïã§Ìå® Ïãú limitÎßå ÏÇ¨Ïö© (ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î∂ÄÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞)
            FRED_RESPONSE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=DTWEXBGS&api_key=$FRED_API_KEY&file_type=json&limit=260&sort_order=desc&observation_end=$(date +%Y-%m-%d)")
          else
            # ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î∂ÄÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏµúÎåÄ 260Í∞ú)
            FRED_RESPONSE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=DTWEXBGS&api_key=$FRED_API_KEY&file_type=json&observation_start=$ONE_YEAR_AGO&sort_order=desc&observation_end=$(date +%Y-%m-%d)")
          fi
          
          echo "$FRED_RESPONSE" > /tmp/fred-response.json
          
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          try {
            const responseData = fs.readFileSync('/tmp/fred-response.json', 'utf8');
            const data = JSON.parse(responseData);
            
            if (data.error_code) {
              console.error('‚ùå FRED API Ïò§Î•ò:', data.error_message);
              process.exit(0);
            }
            
            if (!data.observations || data.observations.length === 0) {
              console.log('‚ö†Ô∏è FRED API ÏùëÎãµÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
              console.log('ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', JSON.stringify(data, null, 2));
              process.exit(0);
            }
            
            console.log('üìä FRED API ÏùëÎãµ Ï†ïÎ≥¥:');
            console.log('  - Ï†ÑÏ≤¥ Í¥ÄÏ∏°Í∞í Í∞úÏàò:', data.observations.length);
            if (data.observations.length > 0) {
              // sort_order=descÏù¥ÎØÄÎ°ú Ï≤´ Î≤àÏß∏Í∞Ä ÏµúÏã†
              console.log('  - Ï≤´ Î≤àÏß∏ Í¥ÄÏ∏°Í∞í (ÏµúÏã†):', JSON.stringify(data.observations[0]));
              console.log('  - ÎßàÏßÄÎßâ Í¥ÄÏ∏°Í∞í (Ïò§ÎûòÎê®):', JSON.stringify(data.observations[data.observations.length - 1]));
            }
            
            // FRED APIÎäî sort_order=descÎ°ú Ìò∏Ï∂úÌñàÏúºÎØÄÎ°ú ÏµúÏã† Îç∞Ïù¥ÌÑ∞Í∞Ä Î®ºÏ†Ä Ïò¥
            // ÌïòÏßÄÎßå ÎÇ†ÏßúÏàú Ï†ïÎ†¨Ïù¥ ÌïÑÏöîÌïòÎØÄÎ°ú ÎÇ†ÏßúÎ°ú Ï†ïÎ†¨
            const observations = data.observations
              .filter(obs => obs.value !== '.' && obs.value !== null)
              .map(obs => ({
                date: obs.date,
                value: parseFloat(obs.value)
              }))
              .sort((a, b) => a.date.localeCompare(b.date)); // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (Ïò§ÎûòÎêú Ïàú)
            
            console.log('üìä ÌïÑÌÑ∞ÎßÅ ÌõÑ Í¥ÄÏ∏°Í∞í Í∞úÏàò:', observations.length);
            
            // ÏµúÍ∑º 52Ï£º Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (ÏïΩ 260 ÏòÅÏóÖÏùº)
            // 52Ï£º = ÏïΩ 260 ÏòÅÏóÖÏùºÏù¥ÎØÄÎ°ú, ÏµúÎåÄ 260Í∞úÍπåÏßÄ ÏÇ¨Ïö©
            // ÌïòÏßÄÎßå Ïã§Ï†úÎ°úÎäî Í∞ÄÎä•Ìïú Ìïú ÎßéÏùÄ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö© (ÏµúÎåÄ 260Í∞ú)
            const maxDays = Math.min(260, observations.length);
            const recent52Weeks = observations.slice(-maxDays); // ÎßàÏßÄÎßâ 260Í∞ú (ÏµúÏã† Îç∞Ïù¥ÌÑ∞)
            
            const values = recent52Weeks.map(obs => obs.value);
            const sorted = [...values].sort((a, b) => a - b);
            
            // ÏµúÏã† Îç∞Ïù¥ÌÑ∞ ÎÇ†Ïßú ÌôïÏù∏
            const latestDate = recent52Weeks[recent52Weeks.length - 1]?.date;
            const latestValue = recent52Weeks[recent52Weeks.length - 1]?.value;
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            // Ï£ºÎßê ÌôïÏù∏ (ÌÜ†ÏöîÏùº=6, ÏùºÏöîÏùº=0)
            const todayDate = new Date();
            const dayOfWeek = todayDate.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            
            console.log('üìÖ ÎÇ†Ïßú Ï†ïÎ≥¥:');
            console.log('  - Ïò§Îäò:', today, isWeekend ? '(Ï£ºÎßê)' : '(ÌèâÏùº)');
            console.log('  - Ïñ¥Ï†ú:', yesterdayStr);
            console.log('  - ÏµúÏã† Îç∞Ïù¥ÌÑ∞ ÎÇ†Ïßú:', latestDate);
            console.log('  - ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Í∞í:', latestValue);
            
            if (latestDate) {
              const latestDateObj = new Date(latestDate);
              const daysDiff = Math.floor((todayDate - latestDateObj) / (1000 * 60 * 60 * 24));
              console.log('  - ÏµúÏã† Îç∞Ïù¥ÌÑ∞ÏôÄ Ïò§ÎäòÏùò Ï∞®Ïù¥:', daysDiff, 'Ïùº');
              
              if (daysDiff > 3 && !isWeekend) {
                console.warn('‚ö†Ô∏è ÏµúÏã† Îç∞Ïù¥ÌÑ∞Í∞Ä 3Ïùº Ïù¥ÏÉÅ ÏßÄÎÇ¨ÏäµÎãàÎã§. FRED API ÏóÖÎç∞Ïù¥Ìä∏ ÏßÄÏó∞ Í∞ÄÎä•ÏÑ±.');
              } else if (daysDiff > 1 && !isWeekend) {
                console.warn('‚ö†Ô∏è ÏµúÏã† Îç∞Ïù¥ÌÑ∞Í∞Ä Ïñ¥Ï†úÎ≥¥Îã§ Ïù¥Ï†ÑÏûÖÎãàÎã§. FRED API ÏóÖÎç∞Ïù¥Ìä∏ ÏßÄÏó∞ Í∞ÄÎä•ÏÑ±.');
              }
            }
            
            const dollarIndexData = {
              date: new Date().toISOString().split('T')[0],
              current: values[values.length - 1], // Í∞ÄÏû• ÏµúÏã†Í∞í
              history: recent52Weeks, // ÏµúÍ∑º 52Ï£º Îç∞Ïù¥ÌÑ∞
              "52week": {
                low: sorted[0],
                high: sorted[sorted.length - 1],
                average: values.reduce((a, b) => a + b, 0) / values.length
              }
            };
            
            console.log('üìä Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Í≤∞Í≥º:');
            console.log('  - Ï†ÑÏ≤¥ Í¥ÄÏ∏°Í∞í:', observations.length);
            console.log('  - ÏÇ¨Ïö©Îêú Îç∞Ïù¥ÌÑ∞:', recent52Weeks.length, 'Í∞ú (ÏµúÍ∑º 52Ï£º, ÏïΩ', Math.round(recent52Weeks.length / 5), 'Ï£º)');
            console.log('  - ÏµúÏã† Îç∞Ïù¥ÌÑ∞ ÎÇ†Ïßú:', latestDate);
            
            const outputPath = 'dollar-investment-web/public/data/dollar-index.json';
            fs.mkdirSync(path.dirname(outputPath), { recursive: true });
            fs.writeFileSync(outputPath, JSON.stringify(dollarIndexData, null, 2));
            console.log('‚úÖ FRED APIÏóêÏÑú Îã¨Îü¨ ÏßÄÏàò Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', dollarIndexData.current);
            console.log('üìà 52Ï£º ÏµúÏ†Ä:', dollarIndexData['52week'].low);
            console.log('üìà 52Ï£º ÏµúÍ≥†:', dollarIndexData['52week'].high);
            console.log('üìà 52Ï£º ÌèâÍ∑†:', dollarIndexData['52week'].average.toFixed(2));
          } catch (e) {
            console.error('‚ùå FRED API Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', e.message);
            process.exit(0); // Ïò§Î•òÍ∞Ä ÏûàÏñ¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
          }
          EOF

      - name: Commit and push
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add dollar-investment-web/public/data/dollar-index.json
          if ! git diff --staged --quiet; then
            git commit -m "Update dollar index data"
            git push
            echo "‚úÖ Dollar index data updated and pushed. Deployment should be triggered automatically."
          else
            echo "No changes to commit - data is already up to date"
          fi
      
      - name: Trigger deployment workflow
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            // Î∞∞Ìè¨ ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏàòÎèôÏúºÎ°ú Ìä∏Î¶¨Í±∞
            const { data: workflows } = await github.rest.actions.listWorkflowsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const deployWorkflow = workflows.workflows.find(
              w => w.name === 'Deploy Dollar Investment Web to GitHub Pages'
            );
            
            if (deployWorkflow) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: deployWorkflow.id,
                ref: 'main',
              });
              console.log('‚úÖ Deployment workflow triggered');
            } else {
              console.log('‚ö†Ô∏è Deployment workflow not found');
            }

