name: Fetch Exchange Rates from Naver

on:
  schedule:
    # í•œêµ­ì‹œê°„ 15ë¶„ ê°„ê²© ì‹¤í–‰ (ì£¼ 7ì¼, 0ì‹œ~24ì‹œ) - ì•ˆì •ì ì¸ ì—…ë°ì´íŠ¸
    - cron: '*/15 * * * *'  # ë§¤ì¼ 15ë¶„ ê°„ê²© (ì•ˆì •ì„± ìš°ì„ )
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  fetch-rates:
    runs-on: ubuntu-latest
    # í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì • (UTC+9)
    env:
      TZ: Asia/Seoul
    # ì•ˆì •ì„± í–¥ìƒì„ ìœ„í•œ ì„¤ì •
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create data directories
      run: |
        mkdir -p data
        mkdir -p data/history
        mkdir -p data/daily
      
    - name: Fetch exchange rates from Naver API (15ë¶„ ê°„ê²©)
      run: |
        echo "=== Naver API Exchange Rate Fetch (ë§¤ì¼ 15ë¶„ ê°„ê²©) ==="
        KST_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
        SEARCH_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')  # í•˜ì´í”ˆ í¬í•¨ í˜•ì‹ìœ¼ë¡œ í†µì¼
        
        echo "Current KST time: $KST_DATE"
        echo "Fetching from Naver API (KEB Hana Bank) - ë§¤ì¼ 15ë¶„ ê°„ê²© ì•ˆì •ì ì¸ ì—…ë°ì´íŠ¸..."
        
        # í†µí™” ëª©ë¡ (ë„¤ì´ë²„ API ì§€ì› í†µí™”)
        CURRENCIES=(
          "USD:ë¯¸êµ­ ë‹¬ëŸ¬:1"
          "JPY:ì¼ë³¸ ì—”:100"
          "EUR:ìœ ë¡œ:1"
          "GBP:ì˜êµ­ íŒŒìš´ë“œ:1"
          "CNY:ì¤‘êµ­ ìœ„ì•ˆ:1"
          "AUD:í˜¸ì£¼ ë‹¬ëŸ¬:1"
          "CAD:ìºë‚˜ë‹¤ ë‹¬ëŸ¬:1"
          "CHF:ìŠ¤ìœ„ìŠ¤ í”„ë‘:1"
          "HKD:í™ì½© ë‹¬ëŸ¬:1"
          "THB:íƒœêµ­ ë°”íŠ¸:1"
          "SGD:ì‹±ê°€í¬ë¥´ ë‹¬ëŸ¬:1"
          "NZD:ë‰´ì§ˆëœë“œ ë‹¬ëŸ¬:1"
          "SEK:ìŠ¤ì›¨ë´ í¬ë¡œë‚˜:1"
          "NOK:ë…¸ë¥´ì›¨ì´ í¬ë¡œë„¤:1"
          "DKK:ë´ë§ˆí¬ í¬ë¡œë„¤:1"
          "MYR:ë§ë ˆì´ì‹œì•„ ë§ê¹ƒ:1"
          "SAR:ì‚¬ìš°ë”” ë¦¬ì–„:1"
          "AED:ì•„ëì—ë¯¸ë¦¬íŠ¸ ë””ë¥´í•¨:1"
          "KWD:ì¿ ì›¨ì´íŠ¸ ë””ë‚˜ë¥´:1"
          "BHD:ë°”ë ˆì¸ ë””ë‚˜ë¥´:1"
          "IDR:ì¸ë„ë„¤ì‹œì•„ ë£¨í”¼ì•„:100"
          "BND:ë¸Œë£¨ë‚˜ì´ ë‹¬ëŸ¬:1"
          "KRW:í•œêµ­ ì›:1"
        )
        
        # í˜„ì¬ ì‹œê°„ì„ KSTë¡œ ì €ì¥ (ISO 8601 í˜•ì‹)
        CURRENT_TIME=$(TZ='Asia/Seoul' date '+%Y-%m-%dT%H:%M:%S%z')
        echo "$CURRENT_TIME" > data/last-update.txt
        echo "ğŸ“… ë°ì´í„° ê¸°ì¤€ ì‹œê°„ ì €ì¥: $CURRENT_TIME"
        
        # JSON ë°°ì—´ ì‹œì‘
        echo "[" > data/exchange-rates.json
        
        FIRST=true
        for currency_info in "${CURRENCIES[@]}"; do
          IFS=':' read -r cur_unit cur_nm multiplier <<< "$currency_info"
          
          echo "Fetching $cur_unit ($cur_nm)..."
          
          # ë„¤ì´ë²„ API í˜¸ì¶œ
          response=$(curl -s "https://m.search.naver.com/p/csearch/content/qapirender.nhn?key=calculator&pkid=141&q=í™˜ìœ¨&where=m&u1=keb&u6=standardUnit&u7=0&u3=$cur_unit&u4=KRW&u8=down&u2=$multiplier")
          
          # í™˜ìœ¨ ì¶”ì¶œ
          rate=$(echo "$response" | jq -r '.country[1].value // "0"')
          
          if [ "$rate" != "0" ] && [ "$rate" != "null" ]; then
            # ì‰¼í‘œ ì œê±° í›„ ê³„ì‚°
            rate_clean=$(echo "$rate" | tr -d ',')
            
            # TTB/TTS ê³„ì‚° (ë§¤ë§¤ê¸°ì¤€ìœ¨ ê¸°ì¤€ Â±1%)
            # TTB (Telegraphic Transfer Buying) = ì€í–‰ì´ ì‚´ ë•Œ (ê³ ê° ì…ì¥ì—ì„œ íŒ” ë•Œ) - ë‚®ì€ ê°€ê²©
            # TTS (Telegraphic Transfer Selling) = ì€í–‰ì´ íŒ” ë•Œ (ê³ ê° ì…ì¥ì—ì„œ ì‚´ ë•Œ) - ë†’ì€ ê°€ê²©
            buy_rate=$(echo "scale=2; $rate_clean * 0.99" | bc)   # ì›ë˜ TTB (ë‚®ìŒ)
            sell_rate=$(echo "scale=2; $rate_clean * 1.01" | bc)  # ì›ë˜ TTS (ë†’ìŒ)
            
            # ì‰¼í‘œ ì¶”ê°€
            rate_formatted="$rate"
            buy_formatted=$(printf "%.2f" $buy_rate)
            sell_formatted=$(printf "%.2f" $sell_rate)
            
            # JSON í•­ëª© ìƒì„± (ttb/tts í•„ë“œë¥¼ ì˜ë„ì ìœ¼ë¡œ ë°˜ëŒ€ë¡œ ë§¤í•‘)
            # ì•±ì—ì„œ ttbë¥¼ "ì‚´ ë•Œ"ë¡œ, ttsë¥¼ "íŒ” ë•Œ"ë¡œ í‘œì‹œí•˜ë¯€ë¡œ ê°’ì„ ë°”ê¿”ì„œ ì €ì¥
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              echo "," >> data/exchange-rates.json
            fi
            
            echo "{\"result\":1,\"cur_unit\":\"$cur_unit\",\"ttb\":\"$sell_formatted\",\"tts\":\"$buy_formatted\",\"deal_bas_r\":\"$rate_formatted\",\"bkpr\":\"${rate_clean%.*}\",\"yy_efee_r\":\"0\",\"ten_dd_efee_r\":\"0\",\"kftc_bkpr\":\"${rate_clean%.*}\",\"kftc_deal_bas_r\":\"$rate_formatted\",\"cur_nm\":\"$cur_nm\"}" >> data/exchange-rates.json
            
            echo "  Success: $cur_nm = $rate_formatted KRW"
          else
            echo "  Skipped: $cur_unit (no data)"
          fi
          
        # API í˜¸ì¶œ ê°„ê²© (Rate limit ë°©ì§€ - 15ë¶„ ê°„ê²©ìœ¼ë¡œ ì¶©ë¶„í•œ ì—¬ìœ )
        sleep 0.1
        done
        
        # JSON ë°°ì—´ ì¢…ë£Œ
        echo "]" >> data/exchange-rates.json
        
        # ë°ì´í„° ê²€ì¦
        DATA_COUNT=$(cat data/exchange-rates.json | jq 'length')
        echo "Total currencies fetched: $DATA_COUNT"
        
        if [ "$DATA_COUNT" -eq 0 ]; then
          echo "Error: No data fetched"
          exit 1
        fi
        
        # íˆìŠ¤í† ë¦¬ ì €ì¥
        HISTORY_FILENAME="data/history/exchange-rates-${SEARCH_DATE}.json"
        DAILY_FILENAME="data/daily/exchange-rates-${SEARCH_DATE}.json"
        
        cp data/exchange-rates.json "$HISTORY_FILENAME"
        
        # í˜„ì¬ ì‹œê°„ í™•ì¸ (KST)
        CURRENT_HOUR=$(TZ='Asia/Seoul' date '+%H')
        CURRENT_MINUTE=$(TZ='Asia/Seoul' date '+%M')
        
        # 15:30 ì¢…ê°€ ì €ì¥ ë¡œì§ (15:30 ~ 15:44 ì‚¬ì´)
        if [ "$CURRENT_HOUR" -eq 15 ] && [ "$CURRENT_MINUTE" -ge 30 ] && [ "$CURRENT_MINUTE" -lt 45 ]; then
          echo "ğŸ”” ì™¸í™˜ì‹œì¥ ì¢…ê°€ ì‹œê°„ (15:30) - ì¢…ê°€ ë°ì´í„° ì €ì¥"
          cp data/exchange-rates.json "$DAILY_FILENAME"
          echo "âœ… ì¢…ê°€ ì €ì¥ ì™„ë£Œ: $DAILY_FILENAME"
          
          # ì¢…ê°€ ë©”íƒ€ë°ì´í„° ìƒì„±
          echo "{\"date\":\"$SEARCH_DATE\",\"fetch_time\":\"$(TZ='Asia/Seoul' date -Iseconds)\",\"api_source\":\"naver_keb\",\"data_count\":$DATA_COUNT,\"is_closing_price\":true,\"closing_time\":\"15:30 KST\"}" > "data/daily/meta-${SEARCH_DATE}.json"
          
        # ì¢…ê°€ íŒŒì¼ì´ ì•„ì§ ì—†ìœ¼ë©´ í˜„ì¬ ë°ì´í„°ë¡œ ì„ì‹œ ì €ì¥
        elif [ ! -f "$DAILY_FILENAME" ]; then
          echo "âš ï¸ ì¢…ê°€ ë°ì´í„° ì—†ìŒ - í˜„ì¬ ë°ì´í„°ë¡œ ì„ì‹œ ì €ì¥ (15:30ì— ê°±ì‹  ì˜ˆì •)"
          cp data/exchange-rates.json "$DAILY_FILENAME"
        else
          echo "ğŸ“Š ì¢…ê°€ ë°ì´í„° ì´ë¯¸ ì¡´ì¬ - ìœ ì§€ (15:30 ì¢…ê°€ ê¸°ì¤€)"
        fi
        
        # ë©”íƒ€ë°ì´í„° ìƒì„±
        echo "{\"date\":\"$SEARCH_DATE\",\"fetch_time\":\"$(TZ='Asia/Seoul' date -Iseconds)\",\"api_source\":\"naver_keb\",\"data_count\":$DATA_COUNT,\"search_date\":\"$SEARCH_DATE\"}" > "data/history/meta-${SEARCH_DATE}.json"
        
        echo "Data saved successfully - ë§¤ì¼ 15ë¶„ ê°„ê²© ì•ˆì •ì ì¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        KST_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
        SEARCH_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')  # í•˜ì´í”ˆ í¬í•¨ í˜•ì‹
        CURRENT_HOUR=$(TZ='Asia/Seoul' date '+%H')
        CURRENT_MINUTE=$(TZ='Asia/Seoul' date '+%M')
        
        if [ -f data/exchange-rates.json ] && [ -s data/exchange-rates.json ]; then
          DATA_LENGTH=$(cat data/exchange-rates.json | jq 'length')
          if [ "$DATA_LENGTH" -gt 0 ]; then
            git add data/exchange-rates.json
            git add data/last-update.txt
            git add data/history/*.json 2>/dev/null || true
            git add data/daily/*.json 2>/dev/null || true
            
            if ! git diff --staged --quiet; then
              COMMIT_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
              
              # ì¢…ê°€ ì‹œê°„ ì—¬ë¶€ ì²´í¬
              CLOSING_TAG=""
              if [ "$CURRENT_HOUR" -eq 15 ] && [ "$CURRENT_MINUTE" -ge 30 ] && [ "$CURRENT_MINUTE" -lt 45 ]; then
                CLOSING_TAG="ğŸ”” [ì¢…ê°€ 15:30] "
              fi
              
              git commit -m "${CLOSING_TAG}Update exchange rates from Naver API - $COMMIT_DATE - Current: data/exchange-rates.json - Daily: data/daily/exchange-rates-$SEARCH_DATE.json - Count: $DATA_LENGTH currencies - Source: Naver KEB API (ë§¤ì¼ 15ë¶„ ê°„ê²©)"
              
              git push
              echo "Exchange rate data updated successfully from Naver API (ë§¤ì¼ 15ë¶„ ê°„ê²©)."
              echo "Stored $DATA_LENGTH currencies - ë§¤ì¼ 24ì‹œê°„ 15ë¶„ ê°„ê²© (ì•ˆì •ì ì¸ ìë™ ì‹¤í–‰)"
            else
              echo "No data changes (ë§¤ì¼ 15ë¶„ ê°„ê²© ì—…ë°ì´íŠ¸)."
            fi
          else
            echo "No valid data to commit."
          fi
        else
          echo "No data file or empty file."
        fi
