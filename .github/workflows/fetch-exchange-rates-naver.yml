name: Fetch Exchange Rates from Naver

on:
  schedule:
    # ÌèâÏùº 30Î∂Ñ Í∞ÑÍ≤© Ïã§Ìñâ (ÌïúÍµ≠ÏãúÍ∞Ñ 9Ïãú~18Ïãú) - ÏïàÏ†ïÏ†ÅÏù∏ Ïã§Ìñâ Î≥¥Ïû•
    - cron: '0,30 0-9 * * 1-5'  # UTC 0Ïãú~9Ïãú = ÌïúÍµ≠ÏãúÍ∞Ñ 9Ïãú~18Ïãú, 30Î∂Ñ Í∞ÑÍ≤©
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  fetch-rates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create data directories
      run: |
        mkdir -p data
        mkdir -p data/history
        mkdir -p data/daily
      
    - name: Fetch exchange rates from Naver API (20Î∂Ñ Í∞ÑÍ≤©)
      run: |
        echo "=== Naver API Exchange Rate Fetch (ÌèâÏùº 20Î∂Ñ Í∞ÑÍ≤©) ==="
        KST_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
        SEARCH_DATE=$(TZ='Asia/Seoul' date '+%Y%m%d')
        
        echo "Current KST time: $KST_DATE"
        echo "Fetching from Naver API (KEB Hana Bank) - 20Î∂Ñ Í∞ÑÍ≤© ÏµúÏ†ÅÌôî..."
        
        # ÌÜµÌôî Î™©Î°ù (ÎÑ§Ïù¥Î≤Ñ API ÏßÄÏõê ÌÜµÌôî)
        CURRENCIES=(
          "USD:ÎØ∏Íµ≠ Îã¨Îü¨:1"
          "JPY:ÏùºÎ≥∏ Ïóî:100"
          "EUR:Ïú†Î°ú:1"
          "GBP:ÏòÅÍµ≠ ÌååÏö¥Îìú:1"
          "CNY:Ï§ëÍµ≠ ÏúÑÏïà:1"
          "AUD:Ìò∏Ï£º Îã¨Îü¨:1"
          "CAD:Ï∫êÎÇòÎã§ Îã¨Îü¨:1"
          "CHF:Ïä§ÏúÑÏä§ ÌîÑÎûë:1"
          "HKD:ÌôçÏΩ© Îã¨Îü¨:1"
          "THB:ÌÉúÍµ≠ Î∞îÌä∏:1"
          "SGD:Ïã±Í∞ÄÌè¨Î•¥ Îã¨Îü¨:1"
          "NZD:Îâ¥ÏßàÎûúÎìú Îã¨Îü¨:1"
          "SEK:Ïä§Ïõ®Îç¥ ÌÅ¨Î°úÎÇò:1"
          "NOK:ÎÖ∏Î•¥Ïõ®Ïù¥ ÌÅ¨Î°úÎÑ§:1"
          "DKK:Îç¥ÎßàÌÅ¨ ÌÅ¨Î°úÎÑ§:1"
          "MYR:ÎßêÎ†àÏù¥ÏãúÏïÑ ÎßÅÍπÉ:1"
          "SAR:ÏÇ¨Ïö∞Îîî Î¶¨ÏñÑ:1"
          "AED:ÏïÑÎûçÏóêÎØ∏Î¶¨Ìä∏ ÎîîÎ•¥Ìï®:1"
          "KWD:Ïø†Ïõ®Ïù¥Ìä∏ ÎîîÎÇòÎ•¥:1"
          "BHD:Î∞îÎ†àÏù∏ ÎîîÎÇòÎ•¥:1"
          "IDR:Ïù∏ÎèÑÎÑ§ÏãúÏïÑ Î£®ÌîºÏïÑ:100"
          "BND:Î∏åÎ£®ÎÇòÏù¥ Îã¨Îü¨:1"
          "KRW:ÌïúÍµ≠ Ïõê:1"
        )
        
        # ÌòÑÏû¨ ÏãúÍ∞ÑÏùÑ KSTÎ°ú Ï†ÄÏû• (ISO 8601 ÌòïÏãù)
        CURRENT_TIME=$(TZ='Asia/Seoul' date '+%Y-%m-%dT%H:%M:%S%z')
        echo "$CURRENT_TIME" > data/last-update.txt
        echo "üìÖ Îç∞Ïù¥ÌÑ∞ Í∏∞Ï§Ä ÏãúÍ∞Ñ Ï†ÄÏû•: $CURRENT_TIME"
        
        # JSON Î∞∞Ïó¥ ÏãúÏûë
        echo "[" > data/exchange-rates.json
        
        FIRST=true
        for currency_info in "${CURRENCIES[@]}"; do
          IFS=':' read -r cur_unit cur_nm multiplier <<< "$currency_info"
          
          echo "Fetching $cur_unit ($cur_nm)..."
          
          # ÎÑ§Ïù¥Î≤Ñ API Ìò∏Ï∂ú
          response=$(curl -s "https://m.search.naver.com/p/csearch/content/qapirender.nhn?key=calculator&pkid=141&q=ÌôòÏú®&where=m&u1=keb&u6=standardUnit&u7=0&u3=$cur_unit&u4=KRW&u8=down&u2=$multiplier")
          
          # ÌôòÏú® Ï∂îÏ∂ú
          rate=$(echo "$response" | jq -r '.country[1].value // "0"')
          
          if [ "$rate" != "0" ] && [ "$rate" != "null" ]; then
            # ÏâºÌëú Ï†úÍ±∞ ÌõÑ Í≥ÑÏÇ∞
            rate_clean=$(echo "$rate" | tr -d ',')
            
            # TTB/TTS Í≥ÑÏÇ∞ (Îß§Îß§Í∏∞Ï§ÄÏú® Í∏∞Ï§Ä ¬±1%)
            ttb=$(echo "scale=2; $rate_clean * 0.99" | bc)
            tts=$(echo "scale=2; $rate_clean * 1.01" | bc)
            
            # ÏâºÌëú Ï∂îÍ∞Ä
            rate_formatted="$rate"
            ttb_formatted=$(printf "%.2f" $ttb)
            tts_formatted=$(printf "%.2f" $tts)
            
            # JSON Ìï≠Î™© ÏÉùÏÑ±
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              echo "," >> data/exchange-rates.json
            fi
            
            echo "{\"result\":1,\"cur_unit\":\"$cur_unit\",\"ttb\":\"$ttb_formatted\",\"tts\":\"$tts_formatted\",\"deal_bas_r\":\"$rate_formatted\",\"bkpr\":\"${rate_clean%.*}\",\"yy_efee_r\":\"0\",\"ten_dd_efee_r\":\"0\",\"kftc_bkpr\":\"${rate_clean%.*}\",\"kftc_deal_bas_r\":\"$rate_formatted\",\"cur_nm\":\"$cur_nm\"}" >> data/exchange-rates.json
            
            echo "  Success: $cur_nm = $rate_formatted KRW"
          else
            echo "  Skipped: $cur_unit (no data)"
          fi
          
        # API Ìò∏Ï∂ú Í∞ÑÍ≤© (Rate limit Î∞©ÏßÄ - 20Î∂Ñ Í∞ÑÍ≤©ÏúºÎ°ú Ï∂©Î∂ÑÌïú Ïó¨Ïú†)
        sleep 0.1
        done
        
        # JSON Î∞∞Ïó¥ Ï¢ÖÎ£å
        echo "]" >> data/exchange-rates.json
        
        # Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
        DATA_COUNT=$(cat data/exchange-rates.json | jq 'length')
        echo "Total currencies fetched: $DATA_COUNT"
        
        if [ "$DATA_COUNT" -eq 0 ]; then
          echo "Error: No data fetched"
          exit 1
        fi
        
        # ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
        HISTORY_FILENAME="data/history/exchange-rates-${SEARCH_DATE}.json"
        DAILY_FILENAME="data/daily/exchange-rates-${SEARCH_DATE}.json"
        
        cp data/exchange-rates.json "$HISTORY_FILENAME"
        cp data/exchange-rates.json "$DAILY_FILENAME"
        
        # Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        echo "{\"date\":\"$SEARCH_DATE\",\"fetch_time\":\"$(TZ='Asia/Seoul' date -Iseconds)\",\"api_source\":\"naver_keb\",\"data_count\":$DATA_COUNT,\"search_date\":\"$SEARCH_DATE\"}" > "data/history/meta-${SEARCH_DATE}.json"
        
        echo "Data saved successfully - 20Î∂Ñ Í∞ÑÍ≤© ÏµúÏ†ÅÌôî ÏôÑÎ£å"
        
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        KST_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
        SEARCH_DATE=$(TZ='Asia/Seoul' date '+%Y%m%d')
        
        if [ -f data/exchange-rates.json ] && [ -s data/exchange-rates.json ]; then
          DATA_LENGTH=$(cat data/exchange-rates.json | jq 'length')
          if [ "$DATA_LENGTH" -gt 0 ]; then
            git add data/exchange-rates.json
            git add data/last-update.txt
            git add data/history/*.json 2>/dev/null || true
            git add data/daily/*.json 2>/dev/null || true
            
            if ! git diff --staged --quiet; then
              COMMIT_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
              
              git commit -m "Update exchange rates from Naver API (20Î∂Ñ Í∞ÑÍ≤©) - $COMMIT_DATE - Current: data/exchange-rates.json - Historical: data/history/exchange-rates-$SEARCH_DATE.json - Daily: data/daily/exchange-rates-$SEARCH_DATE.json - Metadata: data/history/meta-$SEARCH_DATE.json - Count: $DATA_LENGTH currencies - Source: Naver KEB API - Schedule: ÌèâÏùº 20Î∂Ñ Í∞ÑÍ≤© ÏµúÏ†ÅÌôî"
              
              git push
              echo "Exchange rate data updated successfully from Naver API (20Î∂Ñ Í∞ÑÍ≤©)."
              echo "Stored $DATA_LENGTH currencies - ÌèâÏùº 20Î∂Ñ Í∞ÑÍ≤© ÏµúÏ†ÅÌôî"
            else
              echo "No data changes."
            fi
          else
            echo "No valid data to commit."
          fi
        else
          echo "No data file or empty file."
        fi
